<!-- Copilot/AI 使用说明：为 AI 代理提供项目上下文与快速入手要点 -->
# STM32F407 FreeRTOS HwIot 项目 — Copilot 指南

简短目标：帮助 AI 代理快速理解本仓库的结构、运行/调试流程、关键约定与常见改动点，便于实现补丁、修复或新增任务。

- 项目类型：STM32F407 嵌入式工程（ARM Compiler 5.x），基于 FreeRTOS 任务模型，包含 OLED、DS18B20、ESP8266 与华为云物联网接入。
- 典型代码入口：User 层的 `main.c`（任务创建、队列、外设初始化）。示例任务：`OLEDShow_Task`、`DS18B20_Task`、`ESP8266_Task`、`HwIotLED_Task`。

快速定位（示例文件）：
- 主任务与队列：User/main.c
- 外围驱动示例：Hardware/ESP8266.c（参见构建日志编译项）
- 构建产物：`build/Target 1/project.hex`、`build/Target 1/project.s19`

重要架构要点（必须从多个文件联合理解）
- 任务/队列模式：`start_task` 在系统启动时创建所有任务并初始化几个关键队列：`OLED_DS18B20_Queue`（float 温度）、`ESP8266_DS18B20_Queue`（float 温度）、`UART_InfQueue`（uint8_t 字节队列）。请在修改跨任务通信时同时检查发送与接收端（常在 `User` 下各模块）。
- 实时优先级约定：以宏定义为准（如 `OLEDShow_Task_PRIO`、`DS18B20_Task_PRIO`），请不要直接硬编码数字。
- 数据更新策略：温度使用 `xQueueOverwrite`（保留最新值），UI 使用 `xQueueReceive`。修改频率时注意 `vTaskDelay` 的周期权衡。
- 云上报与控制：华为云（HuaweiIot）封装了初始化与上报函数（`HuaweiIot_init`、`HuaweiIot_DevDate_publish`），若改协议或主题名请在对应驱动/库中修改。

构建 / 烧录 / 调试 工作流
- 推荐使用 VS Code 任务（已在工作区定义）：`build`、`flash`、`build and flash`、`rebuild`、`clean`。在 VS Code 中执行 “Run Task” 即可。
- Flash & 验证：项目使用 OpenOCD + ST-Link（构建日志显示 gdbserver 在 3333 端口）。调试时可连接 `localhost:3333`。烧录产物位于 `build/Target 1/project.hex`。
- 编译器与工具链：ARM Compiler 5.06（构建日志里有版本信息）。不要假设 GCC 工具链特性。

项目特有约定与注意事项
- 文件/符号命名：任务以 `_Task` 后缀，句柄以 `*_Handler`，优先级以 `_PRIO` 宏管理。
- 队列大小与类型：温度队列长度为 1（只保留最新），UART 队列使用字节队列（256）。改动这些值需评估内存（RAM 仅 128KB）和实时性。
- 内存/栈：任务堆栈以字数为单位定义（如 `OLEDShow_Task_SIZE`=128），修改须谨慎并观察运行时崩溃或堆栈溢出。
- 外设初始化集中在 `main()`：`LED_Init()`、`Key_Init()`、`OLED_Init()`、`DS18B20_Init()`、`USART1_Init()`、`HuaweiIot_init()`。新增外设驱动请在相似位置初始化。

修改与扩展示例（给 AI 的具体例子）
- 新增温度滤波：在 `DS18B20_Task` 采样后插入滤波函数并继续使用 `xQueueOverwrite` 发布最新值。
- 增加新的上报字段：在 `ESP8266_Task` 中调用 `HuaweiIot_DevDate_publish("New_Field", value)`，并在云端对应主题创建处理。
- 增加调试输出：优先使用现有 `USART1` 报文与 `UART_InfQueue`，避免直接在 ISR 中做重工作。

常见故障与排查要点
- 若程序不启动或卡在启动：检查 `vTaskStartScheduler()` 前外设是否正确初始化、`StartTask_Handler` 是否存在创建失败的返回值。
- 烧录失败或无法连接 ST-Link：查看 OpenOCD 日志（端口/频率），常见提示位于输出终端（gdbserver 在 3333）。
- 运行时内存不足：查看构建报告（RAM/ROM 使用），RAM 已被局部显示为 61.5%（示例），慎增任务堆栈或大数组。

合并注意
- 仓库当前未发现已有的 `.github/copilot-instructions.md`，因此此文件将作为首版 AI 使用指南。如需合并已有文档，请把现有文档路径发给我，我会智能合并保留有价值内容并标注冲突位置。

如果你希望我：
- 将本指南进一步补充为英文版或更详细的“新手上手”步骤，请回复“扩展”；
- 我可以继续扫描更多源文件（驱动、网络栈、Makefile 类配置）并把关键引用追加到本文件中。

---
Generated by AI to help contributors quickly work on this STM32 FreeRTOS project.
